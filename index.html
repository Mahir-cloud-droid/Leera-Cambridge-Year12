<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Drone Swarm AR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<style> body{margin:0;overflow:hidden;} #info{position:fixed;z-index:2;left:10px;top:10px;color:white;font:18px sans-serif} </style>
</head>
<body>
<div id="info">Tap the screen to place the drone swarm</div>
<script type="module">
import * as THREE from 'https://unpkg.com/three@0.152.2/build/three.module.js';
import { GLTFLoader } from 'https://unpkg.com/three@0.152.2/examples/jsm/loaders/GLTFLoader.js';
import { ARButton } from 'https://unpkg.com/three@0.152.2/examples/jsm/webxr/ARButton.js';

let scene, camera, renderer, controller, anchor;
let swarm = [];
let mode = 'default';

// Parse URL parameter ?mode=
const urlParams = new URLSearchParams(window.location.search);
if(urlParams.has('mode')) mode = urlParams.get('mode');

init();

function init(){
scene = new THREE.Scene();
camera = new THREE.PerspectiveCamera();
renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.xr.enabled = true;
renderer.setPixelRatio(window.devicePixelRatio);
document.body.appendChild(renderer.domElement);

// AR button
document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] }));

// Light
const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
scene.add(light);

// Load drone model
const loader = new GLTFLoader();
loader.load('models/drone.glb', gltf => {
const base = gltf.scene;
base.scale.set(0.4,0.4,0.4);

const count = mode==='dance'?6:10; // fewer for dance, more for attack
for(let i=0;i<count;i++){
  const clone = base.clone(true);
  clone.position.set((Math.random()-0.5)*1.2, Math.random()*0.6+0.2, (Math.random()-0.5)*1.2);
  scene.add(clone);
  swarm.push({mesh:clone, angle: Math.random()*Math.PI*2, radius: 0.5+Math.random()*0.8, speed: 0.5+Math.random()});
}

// Auto-play sound
const audio = new Audio(mode==='dance'?'sfx/dance.mp3':'sfx/attack.mp3');
audio.play();
});

// Controller for placing swarm
controller = renderer.xr.getController(0);
controller.addEventListener('select', ()=>{
const pos = new THREE.Vector3();
pos.setFromMatrixPosition(controller.matrixWorld);
if(!anchor){
anchor = new THREE.Group();
anchor.position.copy(pos);
scene.add(anchor);
document.getElementById('info').style.display='none';
}
});
scene.add(controller);

window.addEventListener('resize', onWindowResize);
renderer.setAnimationLoop(render);
}

function render(time){
const t = time0.001;
if(anchor && swarm.length){
swarm.forEach((d,i)=>{
let speedFactor = (mode==='dance'?0.8:1.5);
const a = d.angle + t0.5d.speedspeedFactor;
const x = Math.cos(a)d.radius;
const z = Math.sin(a)d.radius;
const y = 0.2 + 0.2Math.sin(a2 + i);
d.mesh.position.set(anchor.position.x+x, anchor.position.y+y, anchor.position.z+z);
d.mesh.lookAt(anchor.position);
d.mesh.rotation.x += 0.01;
});
}
renderer.render(scene,camera);
}

function onWindowResize(){
renderer.setSize(window.innerWidth, window.innerHeight);
}
</script>
</body>
</html>
